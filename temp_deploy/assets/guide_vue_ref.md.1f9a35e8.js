import{_ as l,o as p,c as o,Q as n,x as s,a}from"./chunks/framework.1456bef9.js";const v=JSON.parse('{"title":"Vue3æºç ","titleTemplate":"Ref","description":"","frontmatter":{"title":"Vue3æºç ","titleTemplate":"Ref"},"headers":[],"relativePath":"guide/vue/ref.md","lastUpdated":1691161495000}'),e={name:"guide/vue/ref.md"},t=n('<h2 id="å‰è¨€" tabindex="-1">å‰è¨€ <a class="header-anchor" href="#å‰è¨€" aria-label="Permalink to &quot;å‰è¨€ {#å‰è¨€}&quot;">â€‹</a></h2><p><strong>ä¸»é¢˜</strong> ç›¸ä¿¡refå’Œreactiveæ˜¯vue3ç”¨çš„æœ€å¤šçš„ä¸¤ä¸ªæ–¹æ³•ï¼Œæœ¬æ–‡æ¥ç€è¿›è¡Œref æºç çš„è§£è¯»</p><p><strong>å†…å®¹</strong> æœ¬æ–‡å°†åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šé¦–å…ˆæ˜¯refçš„ä»‹ç»ï¼Œå…¶æ¬¡æ˜¯refæºç é˜…è¯»ï¼Œæœ€åæ˜¯æ€»ç»“</p><p><strong>ç›®çš„</strong> æ‰‹æ‘¸æ‰‹ æ·±å…¥å­¦ä¹ <a href="https://github.com/vuejs/core/tree/v3.2.47" target="_blank" rel="noreferrer">Vue3.2.47</a>æºç  ref å®ç°åŸç†</p><hr><p><a href="https://juejin.cn/post/7205171975647445052" target="_blank" rel="noreferrer">Vueæºç ä¹‹Reactive</a></p><p><a href="https://juejin.cn/post/7205787772124495928" target="_blank" rel="noreferrer">Vueæºç ä¹‹å·¥å…·å‡½æ•°</a></p><hr>',8),c=s("h2",{id:"ä¸€ã€",refçš„ä»‹ç»åŠä½¿ç”¨:"",tabindex:"-1"},[a("ä¸€ã€ refçš„ä»‹ç»åŠä½¿ç”¨ "),s("a",{class:"header-anchor",href:"#ä¸€ã€","aria-label":'Permalink to "ä¸€ã€ refçš„ä»‹ç»åŠä½¿ç”¨ {#ä¸€ã€ refçš„ä»‹ç»åŠä½¿ç”¨}"'},"â€‹")],-1),r=n(`<p><a href="https://vue3js.cn/vue-composition-api/#ref" target="_blank" rel="noreferrer">å®˜æ–¹ä»‹ç»</a>ï¼šæ¥å—ä¸€ä¸ªå‚æ•°å€¼å¹¶è¿”å›ä¸€ä¸ªå“åº”å¼ä¸”å¯æ”¹å˜çš„ ref å¯¹è±¡ã€‚ref å¯¹è±¡æ‹¥æœ‰ä¸€ä¸ªæŒ‡å‘å†…éƒ¨å€¼çš„å•ä¸€å±æ€§ .valueã€‚</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">script lang</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ts</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> setup</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> count </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ref</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">count</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">++</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(count</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value) </span><span style="color:#676E95;font-style:italic;">// 1</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> newCount </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ref</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  count</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">newCount</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">count</span><span style="color:#89DDFF;">++</span></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(newCount</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">count </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> count</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value) </span><span style="color:#676E95;font-style:italic;">// true</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>ä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œref å¯ä»¥å¯¹è½¬æ¢åŸºç¡€ç±»å‹å’Œå¼•ç”¨ç±»å‹çš„æ•°æ®è¿›è¡Œå“åº”å¼è½¬æ¢ã€‚å› ä¸º<strong>newCount.value.count</strong> å’Œ<strong>count.value</strong>æ˜¯åŒä¸€ä¸ªå’Œå¼•ç”¨åœ°å€ï¼Œæ‰€ä»¥<strong>ä¸¥æ ¼ç›¸ç­‰</strong>ã€‚</p><p>å¦‚æœ<strong>reactive</strong>å¯¹åŸºç¡€æ•°æ®ç±»å‹è½¬æ¢ä¼šæ€ä¹ˆæ ·ï¼Ÿåœ¨å¦ä¸€ç¯‡å…³äº<a href="https://juejin.cn/post/7205171975647445052" target="_blank" rel="noreferrer">Reactiveæºç è§£è¯»</a>çš„æ–‡ç« æœ‰ä»‹ç»ï¼Œdev ä¸‹ä¼šæŠ¥è­¦å‘Šå¹¶è¿”å›åŸå§‹å€¼ï¼ŒProdä¸‹ç›´æ¥è¿”å›åŸå§‹å€¼ã€‚</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">script lang</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ts</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> setup</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> num </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">reactive</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">) </span><span style="color:#676E95;font-style:italic;">// value cannot be made reactive: 1</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>å„ä½çœ‹å®˜ä»¬æ˜¯å¦æœ‰ä»¥ä¸‹ç–‘é—®ï¼š</p><p><strong>refçš„å€¼æ”¹å˜ä¼šè§¦å‘ä»€ä¹ˆæ“ä½œï¼Ÿ</strong></p><p><strong>refå’Œreactiveçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä½¿ç”¨åœºæ™¯åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p><strong>ä¸ºä»€ä¹ˆref å¯ä»¥å°†åŸºç¡€æ•°æ®ç±»å‹è½¬æ¢ä¸ºå“åº”å¼ï¼ŸProxyä¸æ˜¯åªèƒ½ä»£ç†å¯¹è±¡ä¹ˆï¼Ÿ</strong></p><p>å¬è¯´å¸¦ç€é—®é¢˜é˜…è¯»æºç ï¼Œä¼šæœ‰é¢å¤–çš„æ”¶è·ï¼Ÿä¸Šä¸»èœğŸ‘»</p>`,10),y=s("h2",{id:"äºŒã€",refæºç å®ç°:"",tabindex:"-1"},[a("äºŒã€ refæºç å®ç° "),s("a",{class:"header-anchor",href:"#äºŒã€","aria-label":'Permalink to "äºŒã€ refæºç å®ç° {#äºŒã€ refæºç å®ç°}"'},"â€‹")],-1),F=n(`<p><strong>ref</strong>çš„æºç ç›¸æ¯”<strong>reactive</strong>è¿˜æ˜¯ç®€å•å¾ˆå¤šï¼Œä¸»è¦åˆ†ä¸º2ä¸ªæ­¥éª¤ï¼š</p><ol><li>è°ƒcreateRef åˆ¤æ–­ä¼ å…¥çš„å€¼ valueæ˜¯å¦ä¸ºref æ˜¯ç›´æ¥è¿”å›ï¼Œä¸æ˜¯å°±new new RefImplç±»</li><li>RefImplç±»ä¸»è¦æ˜¯ åˆå§‹åŒ–äº†_valueå’Œ_rawValueï¼Œvalueæ˜¯åŸºç¡€ä¸å¤„ç†ï¼Œå¯¹è±¡å°±è°ƒç”¨toReactive è½¬æ¢ï¼Œç„¶åå¯¹setter å’Œgetter æ“ä½œè¿›è¡Œæ‹¦æˆªï¼Œæ·»åŠ ä¾èµ–å’Œé€šçŸ¥è·Ÿæ–°ã€‚</li></ol><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// https://github1s.com/vuejs/core/blob/v3.2.47/packages/reactivity/src/ref.ts#L99-L133</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ref</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">object</span><span style="color:#89DDFF;">&gt;(</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#A6ACCD;font-style:italic;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> [</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;">] </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> [</span><span style="color:#FFCB6B;">Ref</span><span style="color:#A6ACCD;">] </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Ref</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">UnwrapRef</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;&gt;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ref</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;font-style:italic;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Ref</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">UnwrapRef</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;&gt;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ref</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">&gt;():</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Ref</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">undefined</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// value ä»»æ„ç±»å‹</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ref</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">value</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">unknown</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createRef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// rawValue: ä¼ å…¥çš„åŸå§‹å€¼ï¼ˆä»»æ„ç±»å‹ï¼‰ã€shallow æ ‡è¯†æ˜¯å¦æµ…å±‚ ref </span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">createRef</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">rawValue</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">unknown</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">shallow</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isRef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">rawValue</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">// å…¥å‚æœ¬èº«å°±æ˜¯ref é€šè¿‡åˆ¤æ–­å…¥å‚r.__v_isRef === true</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">rawValue</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// ä¸æ˜¯ref è¿”å›ä¸€ä¸ª RefImpl å®ä¾‹</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">RefImpl</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">rawValue</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">shallow</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RefImpl</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">_value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// å†…éƒ¨ç»´æŠ¤ï¼Œå¤–éƒ¨è®¿é—®çš„.value è¿”å›å®ƒ</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">_rawValue</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// æŠ¥å­˜ æ—§å€¼</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">dep</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Dep</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// è°ƒç”¨trackEffects ä¼šä¼ è¿‡å»</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">__v_isRef</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// ref æ ‡è¯†</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// __v_isShallow æ˜¯å¦ æ˜¯æµ…å±‚ref  ä¼ å…¥çš„å€¼ä¸º false</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#C792EA;">constructor</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">__v_isShallow</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">// é€šè¿‡ toRaw  æ‹¿åˆ°åŸå§‹å±æ€§/å¯¹è±¡ å¹¶å­˜åœ¨_rawValeä¸­ï¼Œåé¢åˆ¤æ–­ç”¨</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">_rawValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">__v_isShallow</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">toRaw</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">// value ä¼ å…¥ toReactive å‡½æ•°ï¼Œ</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">// valueæ˜¯å¯¹è±¡åˆ™è°ƒç”¨reactiveç”¨Proxy ä»£ç†,å¦‚æœæ˜¯åŸºç¡€ç±»å‹,åˆ™ç›´æ¥è¿”å› </span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">_value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">__v_isShallow</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">toReactive</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">// çœ‹åˆ°è¿™é‡Œ å†å›é¡¾ä¸Šé¢ ç¬¬ä¸‰é—®ï¼Œæ˜¯ä¸æ˜¯å°±æœ‰ç­”æ¡ˆå•¦</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// æ‹¦æˆª getterå™¨ å±æ€§è®¿é—®æ—¶è§¦å‘</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#C792EA;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">// åœ¨æˆ‘ä»¬è¿›è¡Œ.value æ“ä½œæ—¶ï¼Œ è§¦å‘trackRefValue(this) è¿›è¡Œä¾èµ–æ”¶é›†</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#82AAFF;">trackRefValue</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// åœ¨ä¸‹é¢æœ‰è¯¦ç»†ä»‹ç»</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">// è¿”å› åŸå§‹å€¼/proxy ä»£ç†å¯¹è±¡</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">_value</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// setter æ‹¦æˆªå™¨ å±æ€§æ”¹å˜æ—¶è§¦å‘</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#C792EA;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">value</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">newVal</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">// useDirectValue åˆ¤æ–­æ˜¯å¦ä½¿ç”¨åŸå§‹å€¼ï¼ˆä¸éœ€è¦å“åº”å¼çš„æ ‡è¯†ï¼‰ä»¥ä¸‹3ç§ ä½¿ç”¨åŸå§‹å€¼</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">// 1. å…¥å‚ __v_isShalloww å€¼ä¸ºtrue</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">// 2. isShallow æ–°å¢æ˜¯æµ…å±‚ref</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">// 3. æ–°å€¼æ˜¯åªè¯»</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">useDirectValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">__v_isShallow</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">isShallow</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">newVal</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">isReadonly</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">newVal</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#A6ACCD;">newVal</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">useDirectValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newVal</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">toRaw</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">newVal</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">hasChanged</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">newVal</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">_rawValue</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;font-style:italic;">// å¦‚æœ æ–°å€¼å’Œæ—§å€¼ å‘ç”Ÿäº†æ”¹å˜ï¼Œ è·Ÿæ–°æ—§å€¼</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">_rawValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newVal</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;font-style:italic;">// è®¾ç½® value å€¼ï¼Œéœ€è¦ä½¿ç”¨åŸå§‹å€¼ï¼Œåˆ™ç›´æ¥ç”¨newVal,å¦åˆ™è½¬Proxy</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">_value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">useDirectValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newVal</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">toReactive</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">newVal</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">			</span><span style="color:#676E95;font-style:italic;">// æ´¾å‘äº‹ä»¶ å“åº”å¼è·Ÿæ–°</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#82AAFF;">triggerRefValue</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newVal</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// åœ¨ä¸‹é¢æœ‰è¯¦ç»†ä»‹ç»</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#676E95;font-style:italic;">// çœ‹åˆ°è¿™é‡Œ å¯¹ç¬¬ä¸€é—®æ˜¯ä¸æ˜¯ä¹Ÿæœ‰ç­”æ¡ˆå•¦</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="refimpl-æ‰§è¡Œæ€»ç»“" tabindex="-1">RefImpl æ‰§è¡Œæ€»ç»“ï¼š <a class="header-anchor" href="#refimpl-æ‰§è¡Œæ€»ç»“" aria-label="Permalink to &quot;RefImpl æ‰§è¡Œæ€»ç»“ï¼š&quot;">â€‹</a></h4><ol><li>RefImpl çš„æ„é€ å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ rawValue å’Œ shallowã€‚rawValue è¡¨ç¤º ref å­˜å‚¨çš„å€¼ï¼Œshallow è¡¨ç¤ºæ˜¯å¦æµ…å±‚å¤„ç†ã€‚</li><li>åˆå§‹åŒ–_value å’Œ _rawValue ï¼Œ_rawValueè¡¨ç¤ºåŸå§‹å±æ€§/å¯¹è±¡; _value è¡¨ç¤º åŸºç¡€å€¼åˆ™æ˜¯æœ¬èº«ï¼Œå¼•ç”¨å€¼è¿™æ˜¯é€šè¿‡reactive è¿›è¡Œå“åº”å¼</li><li>æ‹¦æˆªget æ“ä½œï¼Œæ‹¦æˆª è¿›è¡Œä¾èµ–æ”¶é›† å¹¶è¿”å› _value</li><li>æ‹¦æˆªset æ“ä½œï¼Œåˆ¤æ–­æ–°å€¼/æ–°å€¼çš„åŸå§‹å€¼ æ˜¯å¦å’Œæ—§å€¼ç›¸ç­‰ï¼Œä¸ç›¸ç­‰ åˆ™æ›´æ–°value å¹¶é€šçŸ¥ä¾èµ–è·Ÿæ–°</li></ol><h2 id="ä¸‰ã€ä¾èµ–æ”¶é›†" tabindex="-1">ä¸‰ã€ä¾èµ–æ”¶é›† <a class="header-anchor" href="#ä¸‰ã€ä¾èµ–æ”¶é›†" aria-label="Permalink to &quot;ä¸‰ã€ä¾èµ–æ”¶é›† {#ä¸‰ã€ä¾èµ–æ”¶é›†}&quot;">â€‹</a></h2><h4 id="_1-trackrefvalue" tabindex="-1">1. trackRefValue <a class="header-anchor" href="#_1-trackrefvalue" aria-label="Permalink to &quot;1. trackRefValue&quot;">â€‹</a></h4><p>åœ¨ <strong>get</strong> æ‹¦æˆªå™¨ä¸­ï¼Œè°ƒç”¨äº†trackRefValueå‡½æ•°ï¼ŒtrackRefValueå‡½æ•°ï¼š</p><ol><li>åˆ¤æ–­ shouldTrack å’Œ activeEffectï¼Œå­˜åœ¨åˆ™å¾€ä¸‹æ‰§è¡Œ</li><li>æ‹¿åˆ°åŸå§‹å€¼</li><li>è°ƒç”¨trackEffects å¹¶æŠŠ ref.dep ä¼ è¿›å»ï¼Œåˆšå¼€å§‹ ref.depæ˜¯ undefinedï¼Œç„¶ååˆ›å»ºdep</li></ol><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// https://github1s.com/vuejs/core/blob/v3.2.47/packages/reactivity/src/ref.ts#L40-L53</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">trackRefValue</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">ref</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RefBase</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">&gt;)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// shouldTrackä¸ºtrue =&gt; å¤„äºå“åº”å¼çŠ¶æ€</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// activeEffectä¸ä¸ºundefined =&gt; å­˜åœ¨è¿è¡Œçš„Effectå‡½æ•°</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">shouldTrack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">activeEffect</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// æ‹¿åˆ°åŸå§‹å€¼</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// è°ƒç”¨ trackEffects, æŠŠref.dep ä¼ è¿›å»ï¼Œæ²¡æœ‰åˆ™åˆ›å»º</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">ref</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">toRaw</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">ref</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å¼€å‘ç¯å¢ƒ è®°å½•ä¸€äº›è°ƒè¯•ä¿¡æ¯</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">trackEffects</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">ref</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">ref</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createDep</span><span style="color:#F07178;">())</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  target</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ref</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  type</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">TrackOpTypes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">GET</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  key</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">value</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">trackEffects</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">ref</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">ref</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">createDep</span><span style="color:#F07178;">()))</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_2-createdep" tabindex="-1">2. createDep <a class="header-anchor" href="#_2-createdep" aria-label="Permalink to &quot;2. createDep&quot;">â€‹</a></h4><p><strong>createDep</strong> æ˜¯ä¸€ä¸ªåˆ›å»º dep çš„å·¥å‚å‡½æ•°</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// https://github1s.com/vuejs/core/blob/v3.2.47/packages/reactivity/src/dep.ts#L21-L26export</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ä¾èµ–é›†åˆ</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> createDep </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">effects</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ReactiveEffect</span><span style="color:#A6ACCD;">[]</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Dep</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Set</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">ReactiveEffect</span><span style="color:#89DDFF;">&gt;</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">effects</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Dep</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">w</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">n</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">dep</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_3-trackeffects" tabindex="-1">3. trackEffects <a class="header-anchor" href="#_3-trackeffects" aria-label="Permalink to &quot;3. trackEffects&quot;">â€‹</a></h4><p><strong>trackEffects</strong> å‡½æ•°å°±æ˜¯æ ¹æ®ä¼ è¿‡æ¥çš„dep å¯¹è±¡ï¼Œå°†å½“å‰çš„å‰¯ä½œç”¨åŠ å…¥åˆ°æŒ‡å®šçš„ dep ä¸­ï¼Œä»¥ä¾¿ä¾èµ–è·Ÿæ–°æ—¶ è§¦å‘å‰¯ä½œç”¨å‡½æ•°è·Ÿæ–°ã€‚è¿™ä¸ªæ¨¡å—æ¯”è¾ƒç»•ï¼Œæˆ‘ä»¬å…ˆæ¢³ç†ä¸€ä¸‹å‡ ä¸ªæ¦‚å¿µ</p><ol><li><strong>dep</strong> æ¯ä¸ªref å¯¹è±¡æ˜¯ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥æ¯ä¸ªref æœ‰ä¸€ä¸ªå¯¹åº”çš„ depå¯¹è±¡æ¥å­˜å‚¨ è¿™ä¸ªref çš„æ‰€ä»¥ä¾èµ–é¡¹ï¼ˆå°±æ˜¯æ‰€æœ‰ç”¨åˆ°è¿™ä¸ªref çš„åœ°æ–¹ï¼‰ï¼Œæ¯ä¸ªä¾èµ–é¡¹ä¼šå­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªçš„ å‰¯ä½œç”¨å‡½æ•°ï¼Œå‰¯ä½œç”¨å‡½æ•°è¢«å­˜å‚¨åœ¨ä¾èµ–é¡¹çš„deps ä¸­ï¼ˆactiveEffect.deps.push(dep)ï¼‰</li><li>å½“ä¸€ä¸ªå“åº”å¼å¯¹è±¡ref\\reactiveè¢«è®¿é—®æ—¶ï¼Œå®ƒæ‰€å¯¹åº”çš„ <strong>dep</strong> å¯¹è±¡å°±ä¼šè¢«åŠ å…¥å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ï¼ˆå³ <strong>activeEffect</strong>ï¼‰çš„ä¾èµ–åˆ—è¡¨ä¸­ï¼ˆ<strong>activeEffect.deps.push(dep)</strong> ï¼‰ï¼ŒåŒæ—¶è¿™ä¸ª <strong>dep</strong> å¯¹è±¡ä¹Ÿä¼šè®°å½•ä¸‹è¿™ä¸ªå‰¯ä½œç”¨å‡½æ•°ã€‚</li><li><strong>å‡½æ•°å‰¯ä½œç”¨</strong>æŒ‡å‡½æ•°åœ¨æ­£å¸¸å·¥ä½œä»»åŠ¡ä¹‹å¤–å¯¹å¤–éƒ¨ç¯å¢ƒæ‰€æ–½åŠ çš„å½±å“</li></ol><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// https://github1s.com/vuejs/core/blob/v3.2.47/packages/reactivity/src/effect.ts#L232-L257</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> maxMarkerBits </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">30</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">trackEffects</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#A6ACCD;font-style:italic;">dep</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Dep</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// ä¾èµ–é›†åˆ</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#A6ACCD;font-style:italic;">debuggerEventExtraInfo</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DebuggerEventExtraInfo</span></span>
<span class="line"><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">shouldTrack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// æ˜¯å¦åº”è¯¥ è¿½è¸ªä¾èµ–å…³ç³»</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">effectTrackDepth</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">maxMarkerBits</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">/*20*/</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// æ•ˆæœè¿½è¸ªæ·±åº¦å°äºç­‰äºæœ€å¤§æ ‡è®°ä½æ•°</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">newTracked</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å½“å‰çš„ effect ä¸å­˜åœ¨äº† dep</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">n</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">trackOpBit</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// è®¾ç½®æ–°çš„ è¿½è¸ªæ ‡è®°</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">shouldTrack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">wasTracked</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// åˆ¤æ–­æ˜¯å¦åº”è¯¥è¢«è¿½è¸ª</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#676E95;font-style:italic;">// Full cleanup mode. å®Œå…¨æ¸…ç†æ¨¡å¼</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">shouldTrack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">has</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">activeEffect</span><span style="color:#89DDFF;">!</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#676E95;font-style:italic;">/*</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  * effect å“åº”å¼å‰¯ä½œç”¨å‡½æ•°</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  * activeEffect æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ è¡¨ç¤ºå½“å‰æ­£åœ¨è¿è¡Œçš„ effect  </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  * ReactiveEffect è¡¨ç¤ºå“åº”å¼å¯¹è±¡çš„è®¢é˜…è€…</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  * activeEffect!.deps ç”¨äºå­˜å‚¨å½“å‰ effect ä¾èµ–çš„æ‰€æœ‰ dep å¯¹è±¡</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">  */</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// ä¾èµ–åº”è¯¥è¢«è¿½è¸ª =&gt; å°† dep å’Œ å‰¯ä½œç”¨ åŒå‘å…³è”</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">shouldTrack</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å°†å½“å‰æ­£åœ¨æ‰§è¡Œçš„ activeEffect æ·»åŠ åˆ°dep</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// è°ç”¨åˆ°äº†è¿™ä¸ªå“åº”å¼æ•°æ® å°±æŠŠè°æ·»åŠ åˆ°ä¾èµ–æ•°ç»„ä¸­</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">add</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">activeEffect</span><span style="color:#89DDFF;">!</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å°† dep æ·»åŠ åˆ° activeEffect çš„ deps æ•°ç»„ä¸­ï¼Œè¡¨ç¤º activeEffect ä¾èµ–äºè¯¥ depã€‚</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">activeEffect</span><span style="color:#89DDFF;">!.</span><span style="color:#A6ACCD;">deps</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">) </span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">activeEffect</span><span style="color:#89DDFF;">!.</span><span style="color:#A6ACCD;">onTrack</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">activeEffect</span><span style="color:#89DDFF;">!.</span><span style="color:#82AAFF;">onTrack</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  effect</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">activeEffect</span><span style="color:#89DDFF;">!,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">debuggerEventExtraInfo</span><span style="color:#89DDFF;">!</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div>`,17),D=s("h2",{id:"å››ã€",é€šçŸ¥æ›´æ–°:"",tabindex:"-1"},[a("å››ã€ é€šçŸ¥æ›´æ–° "),s("a",{class:"header-anchor",href:"#å››ã€","aria-label":'Permalink to "å››ã€ é€šçŸ¥æ›´æ–° {#å››ã€ é€šçŸ¥æ›´æ–°}"'},"â€‹")],-1),C=n(`<h4 id="_1-triggerrefvalue" tabindex="-1">1. triggerRefValue <a class="header-anchor" href="#_1-triggerrefvalue" aria-label="Permalink to &quot;1. triggerRefValue&quot;">â€‹</a></h4><p>åœ¨ <strong>set</strong> æ‹¦æˆªå™¨ä¸­ è°ƒç”¨triggerRefValueï¼ŒtriggerEffectså‡½æ•°ï¼š</p><ol><li>æ‹¿åˆ°ref çš„åŸå§‹å€¼</li><li>åˆ¤æ–­åŸå§‹å¯¹è±¡æ˜¯å¦å­˜åœ¨ dep</li><li>å­˜åœ¨åˆ™ è°ƒç”¨ triggerEffects å¹¶æŠŠ dep ä¼ è¿›å»</li></ol><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">triggerRefValue</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">ref</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RefBase</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">&gt;,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">newVal</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#A6ACCD;">ref</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">toRaw</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">ref</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// æ‹¿åˆ°åŸå§‹å€¼</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ref</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">dep</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// dep å­˜åœ¨</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å’Œ trackRefValueä¸€æ · è®°å½•ä¸€äº›è°ƒè¯•ä¿¡æ¯</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">triggerEffects</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  target</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ref</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  type</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">TriggerOpTypes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SET</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  key</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">value</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  newValue</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newVal</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">triggerEffects</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="_2-triggereffects" tabindex="-1">2. triggerEffects <a class="header-anchor" href="#_2-triggereffects" aria-label="Permalink to &quot;2. triggerEffects&quot;">â€‹</a></h4><p><strong>triggerEffects</strong> å‡½æ•°å°±æ˜¯éå†ä¾èµ–é¡¹ï¼šé¦–å…ˆåˆå§‹åŒ–effects ï¼Œä¸¤æ¬¡éå†effects ï¼Œ è§¦å‘triggerEffect ï¼Œå°ä¼™ä¼´ä»¬ è¿™é‡Œè‚¯å®šæƒ³é—®ï¼šä¸ºå•¥è¦éå†ä¸¤æ¬¡ï¼Œç›´æ¥åœ¨ä¸€ä¸ªfor ofé‡Œé¢æ–œæ elseä¸å°±è¡Œäº†ä¹ˆï¼Ÿï¼Œè®²å®è¯ï¼Œä¸å¯èƒ½æˆ‘ä»¬éƒ½èƒ½æƒ³åˆ°çš„ï¼Œäººå®¶æ¡†æ¶ä½œè€…æ²¡æœ‰æƒ³åˆ°å™»ã€‚æ‰€ä»¥è¿™é‡Œè‚¯å®šæ˜¯æœ‰åŸå› æ»´ğŸƒ</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">triggerEffects</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#A6ACCD;font-style:italic;">dep</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Dep</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ReactiveEffect</span><span style="color:#A6ACCD;">[]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#A6ACCD;font-style:italic;">debuggerEventExtraInfo</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DebuggerEventExtraInfo</span></span>
<span class="line"><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#676E95;font-style:italic;">// spread into array for stabilization</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effects</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">isArray</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> [</span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;">dep</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">of</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effects</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">computed</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">triggerEffect</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">debuggerEventExtraInfo</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#F07178;"> (</span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">of</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effects</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">computed</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">triggerEffect</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">debuggerEventExtraInfo</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p><strong>éå†ä¸¤æ¬¡</strong>çš„åŸå› æ˜¯ä¸ºäº†ç¡®ä¿å…ˆè§¦å‘æ‰€æœ‰ <strong>computed</strong> çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œå†è§¦å‘<strong>æ™®é€š</strong>çš„å‰¯ä½œç”¨å‡½æ•°ã€‚å› ä¸º <strong>computed</strong> çš„å‰¯ä½œç”¨å‡½æ•°æ˜¯åŸºäºå…¶ä¾èµ–çš„å“åº”å¼æ•°æ®çš„å€¼è®¡ç®—å¾—å‡ºçš„ï¼Œè€Œå“åº”å¼æ•°æ®çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéœ€è¦å…ˆè§¦å‘æ‰€æœ‰è®¡ç®—å±æ€§çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œæ‰èƒ½ç¡®ä¿åç»­æ™®é€šçš„å‰¯ä½œç”¨å‡½æ•°ä½¿ç”¨åˆ°çš„è®¡ç®—å±æ€§çš„å€¼æ˜¯æœ€æ–°çš„ã€‚</p><h4 id="_3-triggereffect" tabindex="-1">3. triggerEffect <a class="header-anchor" href="#_3-triggereffect" aria-label="Permalink to &quot;3. triggerEffect&quot;">â€‹</a></h4><p><strong>triggerEffect</strong>å‡½æ•°ä½œç”¨: è§¦å‘å‰¯ä½œç”¨å‡½æ•° çš„æ‰§è¡Œ run</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">triggerEffect</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#A6ACCD;font-style:italic;">effect</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ReactiveEffect</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#A6ACCD;font-style:italic;">debuggerEventExtraInfo</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DebuggerEventExtraInfo</span></span>
<span class="line"><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ£€æŸ¥è¿™ä¸ªå‰¯ä½œç”¨å‡½æ•°æ˜¯ä¸æ˜¯æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// æ£€æŸ¥è¿™ä¸ªå‰¯ä½œç”¨å‡½æ•°æ˜¯ä¸æ˜¯å¯ä»¥é€’å½’æ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">activeEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">allowRecurse</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// é¿å…è¢«æ— é™å¾ªç¯è°ƒç”¨</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">onTrigger</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onTrigger</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">extend</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">debuggerEventExtraInfo</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// è°ƒåº¦å™¨å‡½æ•°ï¼Œç”¨äºæ§åˆ¶å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">scheduler</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">scheduler</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">      </span><span style="color:#676E95;font-style:italic;">// run å‰¯ä½œç”¨å‡½æ•° çš„æ‰§è¡Œå‡½æ•°</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="è¾…åŠ©å‡½æ•°" tabindex="-1">è¾…åŠ©å‡½æ•° <a class="header-anchor" href="#è¾…åŠ©å‡½æ•°" aria-label="Permalink to &quot;è¾…åŠ©å‡½æ•° {#è¾…åŠ©å‡½æ•°}&quot;">â€‹</a></h2><p>ReactiveEffectæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨ computedã€ref ã€reactive ç­‰å“åº”å¼api æ—¶ï¼Œç”¨æ¥ç®¡ç†å‰¯ä½œç”¨å‡½æ•°çš„ã€‚æˆ‘ä¼šåœ¨ä¸‹ä¸€æœŸå•ç‹¬åˆ†äº«å®ƒï¼Œè¿™é‡Œå°±ä¸åšè¿‡å¤šé˜è¿°ã€‚</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ReactiveEffect</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">active</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">deps</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Dep</span><span style="color:#A6ACCD;">[] </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> []</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">parent</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ReactiveEffect</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">undefined</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">undefined</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Â  Â * Can be attached after creation</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Â  Â * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">internal</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Â  Â */</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">computed</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ComputedRefImpl</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Â  Â * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">internal</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Â  Â */</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">allowRecurse</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">/**</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Â  Â * </span><span style="color:#89DDFF;font-style:italic;">@</span><span style="color:#C792EA;font-style:italic;">internal</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">Â  Â */</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">deferStop</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">onStop</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">void</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// dev only</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">onTrack</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">event</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DebuggerEvent</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">void</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// dev only</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">onTrigger</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">event</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DebuggerEvent</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">void</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">constructor</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">fn</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">scheduler</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">EffectScheduler</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#A6ACCD;font-style:italic;">scope</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">EffectScope</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">recordEffectScope</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">scope</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">run</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!this.</span><span style="color:#A6ACCD;">active</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">fn</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">parent</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">ReactiveEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">undefined</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">activeEffect</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lastShouldTrack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">shouldTrack</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">parent</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">parent</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">parent</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">parent</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">parent</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">parent</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">activeEffect</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">activeEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">shouldTrack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">trackOpBit</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">++</span><span style="color:#A6ACCD;">effectTrackDepth</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">effectTrackDepth</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">maxMarkerBits</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">initDepMarkers</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">cleanupEffect</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">fn</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">finally</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">effectTrackDepth</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">maxMarkerBits</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#82AAFF;">finalizeDepMarkers</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">trackOpBit</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">--</span><span style="color:#A6ACCD;">effectTrackDepth</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">activeEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">parent</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#A6ACCD;">shouldTrack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lastShouldTrack</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">parent</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">deferStop</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">stop</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#F07178;">stop</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// stopped while running itself - defer the cleanup</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">activeEffect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">deferStop</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">active</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">cleanupEffect</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">this</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">onStop</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">this.</span><span style="color:#82AAFF;">onStop</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">this.</span><span style="color:#A6ACCD;">active</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// åˆ¤æ–­æ˜¯å¦æ˜¯ ref</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isRef</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;font-style:italic;">r</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Ref</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">unknown</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">r</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Ref</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isRef</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">r</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">r</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Ref</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!!</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">r</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">r</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__v_isRef</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// è·å–åŸå§‹å€¼</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">toRaw</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;font-style:italic;">observed</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">raw</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">observed</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">observed</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Target</span><span style="color:#F07178;">)[</span><span style="color:#A6ACCD;">ReactiveFlags</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RAW</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">raw</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">toRaw</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">raw</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">observed</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// å¯¹è±¡åˆ™è°ƒç”¨ reactive ï¼Œ å¦åˆ™ è¿”å›æœ¬èº«</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> toReactive </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">unknown</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;font-style:italic;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#82AAFF;">isObject</span><span style="color:#A6ACCD;">(value) </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">reactive</span><span style="color:#A6ACCD;">(value) </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> value</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// åˆ¤æ–­æ˜¯å¦æ˜¯å¯¹è±¡</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> isObject </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">val</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">unknown</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">val</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Record</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  val </span><span style="color:#89DDFF;">!==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">typeof</span><span style="color:#A6ACCD;"> val </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">object</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// åˆ¤æ–­å€¼æ˜¯å¦å‘ç”Ÿæ”¹å˜</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> hasChanged </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">oldValue</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">is</span><span style="color:#A6ACCD;">(value</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> oldValue)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> newTracked </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">dep</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Dep</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> (dep</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">n </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;"> trackOpBit) </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> wasTracked </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">dep</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Dep</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> (dep</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">w </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;"> trackOpBit) </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"></span></code></pre></div><h2 id="æ€»ç»“" tabindex="-1">æ€»ç»“ <a class="header-anchor" href="#æ€»ç»“" aria-label="Permalink to &quot;æ€»ç»“ {#æ€»ç»“}&quot;">â€‹</a></h2><p><strong>ref</strong>ï¼š</p><ul><li>ref æ˜¯ç”¨äºå°† reactive å¤„ç†ä¸äº†çš„ <strong>åŸºç¡€æ•°æ®</strong>ç±»å‹ è½¬ä¸ºå“åº”å¼</li><li>ref ä¹Ÿå¯ä»¥ä¼ å…¥å¼•ç”¨æ•°æ®ç±»å‹ï¼Œå†…éƒ¨å€ŸåŠ©äº†toReactive</li><li>åªèƒ½é€šè¿‡ .value è®¿é—®å’Œä¿®æ”¹</li><li>æœ¬è´¨æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ä¸€ä¸ªvalueå€¼å’Œä¸€ä¸ªgetter/setterå‡½æ•°ã€‚</li></ul><p><strong>ä¾èµ–æ”¶é›†åŠé€šçŸ¥æ›´æ–°ï¼š</strong></p><ul><li>å¯¹å“åº”å¼æ•°æ®è®¿é—®æ˜¯ï¼Œget æ‹¦æˆªï¼Œè¿›è¡Œä¾èµ–çš„æ”¶é›†</li><li>å¯¹å“åº”å¼æ•°æ®ä¿®æ”¹æ—¶ï¼Œset æ‹¦æˆªï¼Œéå†ä¾èµ– å¹¶æ‰§è¡Œä¾èµ–çš„å‰¯ä½œç”¨å‡½æ•°</li></ul><p><strong>ref å’Œ reactive</strong>ï¼šreactive å’Œ ref åœ¨æ¨¡æ¿ä¸­éƒ½æ˜¯ç›´æ¥ä½¿ç”¨çš„</p><table><thead><tr><th></th><th>å…¥å‚</th><th>å“åº”å®ç°</th><th>è®¿é—®æ–¹å¼</th><th>ä¿®æ”¹</th></tr></thead><tbody><tr><td>reactive</td><td>å¼•ç”¨ç±»å‹</td><td>Proxy</td><td>obj.xx</td><td>obj.xx = xx</td></tr><tr><td>ref</td><td>ä»»æ„ç±»å‹</td><td>Proxy / get + set</td><td>obj.value.xx</td><td>obj.value.xx = xx</td></tr></tbody></table><hr>`,23),A=[t,c,r,y,F,D,C];function i(f,u,d,g,E,h){return p(),o("div",null,A)}const _=l(e,[["render",i]]);export{v as __pageData,_ as default};
