import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.793cb3e4.js";const i=JSON.parse('{"title":"Vue3æºç ","titleTemplate":"Ref","description":"","frontmatter":{"title":"Vue3æºç ","titleTemplate":"Ref"},"headers":[],"relativePath":"guide/vue/watch.md","lastUpdated":1722952135000}'),p={name:"guide/vue/watch.md"},o=l(`<h2 id="å‰è¨€" tabindex="-1">å‰è¨€ <a class="header-anchor" href="#å‰è¨€" aria-label="Permalink to &quot;å‰è¨€ {#å‰è¨€}&quot;">â€‹</a></h2><p><strong>ä¸»é¢˜</strong>ï¼š æœ¬æ–‡å°†æ·±å…¥æ¢è®¨<a href="https://github.com/vuejs/core/tree/v3.2.47" target="_blank" rel="noreferrer">Vue3.2.47</a>ä¸­<strong>watch</strong>å’Œ<strong>watchEffect</strong>çš„å®ç°</p><p><strong>å†…å®¹</strong>ï¼š æœ¬æ–‡å°†åˆ†ä¸º3ä¸ªéƒ¨åˆ†ï¼šé¦–å…ˆæ˜¯ä»‹ç»åŠä½¿ç”¨ï¼Œç„¶åæ˜¯æºç é˜…è¯»ï¼Œæœ€åæ˜¯æ€»ç»“åŠæ³¨æ„äº‹é¡¹</p><p><strong>ç›®çš„</strong>ï¼š æ‰‹æ¨¡æ‰‹æ·±å…¥å­¦ä¹ <strong>watch</strong>å’Œ<strong>watchEffect</strong>åŸç†ï¼Œæ–¹ä¾¿å¼€å‘æ’é—®é¢˜åŠé¢è¯•æ´¾ä¸Šç”¨åœºğŸ˜</p><hr><p><a href="https://juejin.cn/post/7205171975647445052" target="_blank" rel="noreferrer">Vue3æºç ä¹‹Reactive</a><br><a href="https://juejin.cn/post/7205787772124495928" target="_blank" rel="noreferrer">Vue3æºç ä¹‹æ‹¦æˆªå·¥å…·å‡½æ•°</a><br><a href="https://juejin.cn/post/7206508940640124987" target="_blank" rel="noreferrer">Vue3æºç ä¹‹ref + ä¾èµ–æ”¶é›† + é€šçŸ¥æ›´æ–°</a><br><a href="https://juejin.cn/post/7208111879151566904" target="_blank" rel="noreferrer">Vue3æºç ä¹‹Computed</a><br><a href="https://juejin.cn/post/7209510210422685755" target="_blank" rel="noreferrer">Vue3æºç ä¹‹effect</a></p><hr><h2 id="ä¸€ã€watchå’ŒwatchEffectä½¿ç”¨" tabindex="-1">ä¸€ã€watchå’ŒwatchEffectä½¿ç”¨ <a class="header-anchor" href="#ä¸€ã€watchå’ŒwatchEffectä½¿ç”¨" aria-label="Permalink to &quot;ä¸€ã€watchå’ŒwatchEffectä½¿ç”¨ {#ä¸€ã€watchå’ŒwatchEffectä½¿ç”¨}&quot;">â€‹</a></h2><h3 id="_1-watchå®šä¹‰åŠä½¿ç”¨" tabindex="-1">1. watchå®šä¹‰åŠä½¿ç”¨ <a class="header-anchor" href="#_1-watchå®šä¹‰åŠä½¿ç”¨" aria-label="Permalink to &quot;1. watchå®šä¹‰åŠä½¿ç”¨&quot;">â€‹</a></h3><p><a href="https://cn.vuejs.org/api/reactivity-core.html#watch" target="_blank" rel="noreferrer">å®˜æ–¹</a>ï¼šä¾¦å¬ä¸€ä¸ªæˆ–å¤šä¸ªå“åº”å¼æ•°æ®æºï¼Œå¹¶åœ¨æ•°æ®æºå˜åŒ–æ—¶è°ƒç”¨æ‰€ç»™çš„å›è°ƒå‡½æ•°ã€‚</p><p><strong>watch</strong> æœ¬è´¨æ˜¯ä¸€ä¸ªæ•°æ®ç›‘å¬å™¨ï¼Œåœ¨ç›‘å¬çš„æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰§è¡Œæˆ‘ä»¬çš„å›è°ƒã€‚</p><p><strong>å‚æ•°3ä¸ª</strong>ï¼šç›‘å¬æ•°æ®ã€å›è°ƒå‡½æ•°ã€é…ç½®å¯¹è±¡</p><p><strong>ç›‘å¬æ•°æ®</strong>ï¼šå‡½æ•°è¿”å›å€¼ã€refã€reactiveã€computedã€å‰å‡ ä¸ªç»„æˆçš„æ•°ç»„</p><p><strong>å›è°ƒå‡½æ•°</strong>ï¼šç›‘å¬çš„æ•°æ®æ”¹å˜æ—¶ï¼Œéœ€è¦æ‰§è¡Œçš„æ“ä½œå¦‚ï¼šå¼‚æ­¥è¯·æ±‚ã€æ”¹å˜çŠ¶æ€ã€è·¯ç”±è·³è½¬ç­‰</p><p><strong>é…ç½®å¯¹è±¡</strong>ï¼š</p><ul><li><strong>immediate</strong> æ˜¯å¦ç«‹å³æ‰§è¡Œ</li><li><strong>deep</strong> æ˜¯å¦æ·±åº¦ç›‘å¬ï¼ˆé’ˆå¯¹å¯¹è±¡ã€æ•°ç»„ï¼‰</li><li><strong>flush</strong> æ§åˆ¶å›è°ƒå‡½æ•°çš„<strong>æ‰§è¡Œæ—¶æœº</strong> åŒæ­¥/å¼‚æ­¥ domæ›´æ–°å‰/å</li><li><strong>onTack</strong>/<strong>onTrigger</strong> è°ƒè¯•ä¾¦å¬å™¨çš„ä¾èµ–</li></ul><p><strong>è¿”å›å€¼</strong>ï¼šç»ˆæ­¢ç›‘å¬</p><p>æ¥ä¸‹æ¥ä½¿ç”¨ä¸€ä¸‹<strong>watch</strong>,ä¸‹é¢ä»£ç æ˜¯é€šè¿‡ç›‘å¬<strong>ref</strong>æ•°æ®count</p><p><a href="https://github.com/xiaoyi1255/nuxt3-temple.git" target="_blank" rel="noreferrer">ç¤ºä¾‹æºç ï¼š</a></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">template</span><span style="color:#A6ACCD;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  &lt;</span><span style="color:#FFCB6B;">h1</span><span style="color:#A6ACCD;">&gt;å€’è®¡æ—¶ </span><span style="color:#89DDFF;">{{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}}</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">h1</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">button </span><span style="color:#89DDFF;">@</span><span style="color:#A6ACCD;">click</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">() =&gt; run()</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">å¼€å¯å€’è®¡æ—¶</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">button</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  &lt;</span><span style="color:#FFCB6B;">br</span><span style="color:#A6ACCD;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  &lt;</span><span style="color:#FFCB6B;">br</span><span style="color:#A6ACCD;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">button </span><span style="color:#89DDFF;">@</span><span style="color:#A6ACCD;">click</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">() =&gt; stopWatch()</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">ç»ˆæ­¢ç›‘å¬</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">button</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">script setup lang</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ts</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> count </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ref</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">60</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> timer</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">NodeJS</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Timer</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> run </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#A6ACCD;">timer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">setInterval</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">count</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">window</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clearInterval</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">timer</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">count</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">--;</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1000</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> stopWatch </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">watch</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> count</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">newVal</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">oldVal</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newVal</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldVal</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  Â  </span><span style="color:#F07178;">immediate</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  Â  </span><span style="color:#F07178;">deep</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p>ä¸‹é¢æ˜¯ç•Œé¢çš„æ‰§è¡Œæƒ…å†µï¼š</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d93656df61e447839260cb40c574aee7~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p><p>å› ä¸ºæˆ‘ä»¬ ç›‘å¬çš„ <strong>count.value</strong> è®¾ç½®äº† <strong>immediate</strong> ä¸ºtrueï¼Œæ‰€ä»¥é»˜è®¤ä¼šæ‰§è¡Œï¼Œæ§åˆ¶å°ä¼šæ‰“å° { &quot;newVal&quot;: 60ï¼Œ&quot;oldValue&quot;: undefined }, å½“æˆ‘ç‚¹å‡»å¼€å¯å€’è®¡æ—¶æŒ‰é’®ï¼š<strong>setInterval</strong> å€’è®¡æ—¶åœ¨ä¿®æ”¹counçš„å€¼ï¼Œæ§åˆ¶å°æ¯ä¸ªä¸€ç§’æ‰“å°ä¸€æ¬¡ï¼›å½“æˆ‘ç‚¹å‡»äº†åœæ­¢ç›‘å¬æŒ‰é’®ï¼šæ‰§è¡Œäº†è¿”å›çš„ <strong>stopWatch</strong> å‡½æ•°ï¼Œç»ˆæ­¢äº†ç›‘å¬ï¼Œæ§åˆ¶å°ä¾¿æ²¡æœ‰å†æ‰“å°ã€‚</p><h3 id="_2-watcheffect" tabindex="-1">2. watchEffect <a class="header-anchor" href="#_2-watcheffect" aria-label="Permalink to &quot;2. watchEffect&quot;">â€‹</a></h3><p><a href="https://cn.vuejs.org/api/reactivity-core.html#watcheffect" target="_blank" rel="noreferrer">å®˜æ–¹</a>ï¼šç«‹å³è¿è¡Œä¸€ä¸ªå‡½æ•°ï¼ŒåŒæ—¶å“åº”å¼åœ°è¿½è¸ªå…¶ä¾èµ–ï¼Œå¹¶åœ¨ä¾èµ–æ›´æ”¹æ—¶é‡æ–°æ‰§è¡Œã€‚</p><p><strong>watchEffect</strong> å’Œ <strong>watch</strong> éƒ½æ˜¯ç”¨æ¥ç›‘å¬æ•°æ®çš„ã€‚åªæ˜¯watchEffectä¸èƒ½æŒ‡å®šç›‘å¬çš„æ•°æ®æº</p><p><strong>å‚æ•°2ä¸ª</strong>ï¼šå›è°ƒå’Œé…ç½®å¯¹è±¡ å›è°ƒå‚æ•°ï¼Œç”¨æ¥<strong>æ¸…é™¤å‰¯ä½œç”¨</strong></p><p><strong>å›è°ƒçš„æ‰§è¡Œ</strong>ï¼šwatch è®¾ç½®äº†æ‰èƒ½ç«‹å³æ‰§è¡Œï¼ŒwatchEffect<em>é»˜è®¤ç«‹å³æ‰§è¡Œ</em></p><p><strong>è¿”å›å€¼</strong>ï¼šç»ˆæ­¢ç›‘å¬</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&lt;</span><span style="color:#FFCB6B;">template</span><span style="color:#A6ACCD;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  &lt;</span><span style="color:#FFCB6B;">h1</span><span style="color:#A6ACCD;">&gt;å€’è®¡æ—¶ </span><span style="color:#89DDFF;">{{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">count</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}}</span><span style="color:#A6ACCD;"> s</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">h1</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">button </span><span style="color:#89DDFF;">@</span><span style="color:#A6ACCD;">click</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">() =&gt; run()</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">å¼€å¯å€’è®¡æ—¶</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">button</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  &lt;</span><span style="color:#FFCB6B;">br</span><span style="color:#A6ACCD;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  &lt;</span><span style="color:#FFCB6B;">br</span><span style="color:#A6ACCD;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">button </span><span style="color:#89DDFF;">@</span><span style="color:#A6ACCD;">click</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">() =&gt; stopWatch()</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">ç»ˆæ­¢ç›‘å¬</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">button</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  &lt;</span><span style="color:#FFCB6B;">br</span><span style="color:#A6ACCD;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  &lt;</span><span style="color:#FFCB6B;">br</span><span style="color:#A6ACCD;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">button </span><span style="color:#89DDFF;">@</span><span style="color:#A6ACCD;">click</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">() =&gt; stopWatchEffect()</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">ç»ˆæ­¢ç›‘å¬</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">button</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">template</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">script setup lang</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ts</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> count </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ref</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">60</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> timer</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">NodeJS</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Timer</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> run </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#A6ACCD;">timer</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">setInterval</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">count</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">window</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">clearInterval</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">timer</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">count</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">--;</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">},</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1000</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> stopWatch </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">watch</span><span style="color:#A6ACCD;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> count</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">newVal</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">oldVal</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">watchç›‘å¬</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newVal</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldVal</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  Â  </span><span style="color:#F07178;">immediate</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  Â  </span><span style="color:#F07178;">deep</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> stopWatchEffect </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">watchEffect</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">watchEfectç›‘å¬</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">count</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">},{}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#A6ACCD;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e11087b7a2964493870548aa4e33ce98~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p><p><strong>watchEffect</strong></p><p><strong>ä¼˜åŠ¿</strong>ï¼šä¸éœ€è¦æŒ‡å®šå…·ä½“ç›‘å¬çš„å€¼ã€å¯¹è±¡å¹¶ä¸”æ˜¯ç«‹å³æ‰§è¡Œçš„</p><p><strong>åŠ£åŠ¿</strong>ï¼šä¸èƒ½æŒ‡å®šå…·ä½“çš„å€¼ï¼Œå›è°ƒé‡Œé¢ä½¿ç”¨çš„ï¼Œå…¶ä¸­ä¸€ä¸ªå˜ï¼Œå›è°ƒå°±ä¼šæ‰§è¡Œï¼Œä¸èƒ½æŒ‡å®šç¬¬ä¸€æ¬¡æ˜¯å¦æ‰§è¡Œ</p><h3 id="watchå’Œwatcheffectæ€»ç»“" tabindex="-1">watchå’ŒwatchEffectæ€»ç»“ï¼š <a class="header-anchor" href="#watchå’Œwatcheffectæ€»ç»“" aria-label="Permalink to &quot;watchå’ŒwatchEffectæ€»ç»“ï¼š&quot;">â€‹</a></h3><table><thead><tr><th></th><th>watch</th><th>watchEffect</th></tr></thead><tbody><tr><td>é»˜è®¤ç«‹å³æ‰§è¡Œ</td><td>å¦ å¯ä»¥é…ç½®</td><td>æ˜¯</td></tr><tr><td>å‚æ•°</td><td>ç›‘å¬å€¼ã€å›è°ƒã€é…ç½®å¯¹è±¡</td><td>å›è°ƒã€é…ç½®å¯¹è±¡</td></tr><tr><td>å›è°ƒæ”¯æŒå¼‚æ­¥</td><td>æ˜¯</td><td>æ˜¯</td></tr><tr><td>æ”¯æŒç»ˆæ­¢ç›‘å¬</td><td>æ˜¯</td><td>æ˜¯</td></tr><tr><td>é…ç½®å¯¹è±¡options</td><td>immediate, deep, flush, onTrack, onTrigger</td><td>flush, onTrack, onTrigger</td></tr><tr><td>source</td><td>ç›‘å¬æ•°æ®æº</td><td>å›è°ƒå‡½æ•°ï¼Œå®ƒçš„å‚æ•°æ˜¯æ¸…ç†å‰¯ä½œç”¨çš„å‡½æ•°</td></tr><tr><td>å›è°ƒå‡½æ•° cb</td><td>å›è°ƒå‡½æ•°ï¼ˆnewVal,oldValï¼‰</td><td>null</td></tr></tbody></table><p>ä»¥ä¸Šå°±æ˜¯watchå’ŒwatchEffectçš„ç®€å•ä½¿ç”¨åŠåŒºåˆ«ï¼Œæ¥ä¸‹è¿˜æ˜¯ ä¸Šä¸»èœğŸ‘»ğŸ‘»</p><h2 id="äºŒã€æºç é˜…è¯»" tabindex="-1">äºŒã€æºç é˜…è¯» <a class="header-anchor" href="#äºŒã€æºç é˜…è¯»" aria-label="Permalink to &quot;äºŒã€æºç é˜…è¯» {#äºŒã€æºç é˜…è¯»}&quot;">â€‹</a></h2><p>ä»¥å¾€è¿›è¡Œæºç é˜…è¯»éƒ½æ˜¯ä¸€è‚¡è„‘å¾€ä¸‹é˜…è¯»ï¼Œå‘ç°é‚£æ ·å®¹æ˜“è§†è§‰ç–²ä¹ï¼Œæ‰€ä»¥è¿™æ¬¡é€‰æ‹©æŠŠæ•´ä½“è¿‡ä¸€éï¼Œç„¶é’ˆå¯¹æ ¸å¿ƒä»£ç æ¨¡å—å»é˜…è¯»ã€‚å¹³å¸¸ä½ ä»¬æ˜¯æ€ä¹ˆå»é˜…è¯»çš„å‘¢ï¼Ÿ</p><p><a href="https://github1s.com/vuejs/core/blob/v3.2.47/packages/runtime-core/src/apiWatch.ts#L157-L170" target="_blank" rel="noreferrer">æºç </a>ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š<strong>watch</strong>å’Œ<strong>watchEffect</strong>éƒ½æ˜¯è°ƒçš„ <strong>deWatch</strong> åªæ˜¯ <strong>watchEffect</strong>è°ƒæ—¶ç¬¬äºŒä¸ªå‚æ•°ä¸ºnull</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// https://github1s.com/vuejs/core/blob/v3.2.47/packages/runtime-core/src/apiWatch.ts#L157-L170</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">watch</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Immediate</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">extends</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Readonly</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">boolean</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">false</span><span style="color:#89DDFF;">&gt;(</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#A6ACCD;font-style:italic;">source</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">T</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchSource</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">T</span><span style="color:#89DDFF;">&gt;,</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#A6ACCD;font-style:italic;">cb</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#A6ACCD;font-style:italic;">options</span><span style="color:#89DDFF;">?:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchOptions</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Immediate</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchStopHandle</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;font-style:italic;">// (val: unknown): val is Function =&gt; typeof val === &#39;function&#39;</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#82AAFF;">isFunction</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// devä¸‹ å›è°ƒä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼ŒæŠ¥è­¦å‘Š</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">warn</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">\`\`</span><span style="color:#82AAFF;">watch</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">fn</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">options</span><span style="color:#89DDFF;">?</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;"> signature has been moved to a separate API. </span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">Use </span><span style="color:#89DDFF;">\`</span><span style="color:#82AAFF;">watchEffect</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">fn</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">options</span><span style="color:#89DDFF;">?</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;"> instead. </span><span style="color:#89DDFF;">\`</span><span style="color:#82AAFF;">watch</span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;"> now only </span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">supports </span><span style="color:#89DDFF;">\`</span><span style="color:#82AAFF;">watch</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cb</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">options</span><span style="color:#89DDFF;">?</span><span style="color:#F07178;">) </span><span style="color:#A6ACCD;">signature</span><span style="color:#89DDFF;">.</span><span style="color:#89DDFF;">\`</span></span>
<span class="line"><span style="color:#C3E88D;">Â  Â  )</span></span>
<span class="line"><span style="color:#C3E88D;">Â  }</span></span>
<span class="line"><span style="color:#C3E88D;">  // è¿”å› doWatchçš„æ‰§è¡Œç»“æœ</span></span>
<span class="line"><span style="color:#C3E88D;">Â  return doWatch(source as any, cb, options)</span></span>
<span class="line"><span style="color:#C3E88D;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C3E88D;">export function watchEffect(</span></span>
<span class="line"><span style="color:#C3E88D;">  effect: WatchEffect,</span></span>
<span class="line"><span style="color:#C3E88D;">  options?: WatchOptionsBase</span></span>
<span class="line"><span style="color:#C3E88D;">): WatchStopHandle {</span></span>
<span class="line"><span style="color:#C3E88D;">  return doWatch(effect, null, options)</span></span>
<span class="line"><span style="color:#C3E88D;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="dowatch" tabindex="-1">doWatch <a class="header-anchor" href="#dowatch" aria-label="Permalink to &quot;doWatch&quot;">â€‹</a></h3><p>å…ˆé˜è¿°ä¸€ä¸‹<strong>doWatch</strong>å‡½æ•°åšäº†å“ªäº›äº‹æƒ…</p><ol><li>é¦–å…ˆæ˜¯æ ¡éªŒå‚æ•°ã€æ ¹æ®å‚æ•°åˆ›å»º/ç›´æ¥ä½¿ç”¨getterå‡½æ•°</li><li>é’ˆå¯¹2.x watch ç›‘å¬æ•°ç»„åšå…¼å®¹</li><li>ç›‘å¬æ•°æ®æ˜¯reactive <strong>deep</strong>é»˜è®¤ä¸º<strong>true</strong> æ ¹æ®deep æ”¹é€ getterå®ç°æ·±åº¦ç›‘å¬</li><li>æ ¹æ®option: flushå°†job åŠ å…¥è°ƒåº¦å™¨ schedulerä¸­</li><li>å®ä¾‹åŒ–effect ä¼ å…¥ getter å’Œ scheduler</li><li>æ ¹æ®åˆ¤æ–­ ä¼ å…¥ immediateå¹¶ä¸ºtrue åˆ™ç«‹å³æ‰§è¡Œä¸€æ¬¡effect</li><li>æœ€åè¿”å›ä¸€ä¸ªç”¨äºç»ˆæ­¢ç›‘å¬çš„å‡½æ•°</li></ol><p>é˜‰å‰²ç‰ˆçš„<strong>doWatch</strong></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">doWatch</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">source</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchSource</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchSource</span><span style="color:#A6ACCD;">[] </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchEffect</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">object</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#A6ACCD;font-style:italic;">cb</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchCallback</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">immediate</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">deep</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">flush</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">onTrack</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">onTrigger</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchOptions</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> EMPTY_OBJ</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchStopHandle</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;font-style:italic;">// devä¸‹ æ²¡æœ‰ä¼ å›è°ƒä¼šæŠ¥è­¦å‘Š</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{...}</span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;font-style:italic;">// å£°æ˜æ•°æ®æ ¡éªŒä¸è¿‡è­¦å‘Šå‡½æ•°</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">warnInvalidSource</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">s</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">unknown</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// ç»„ä»¶å®ä¾‹</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">getCurrentScope</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">currentInstance</span><span style="color:#89DDFF;">?.</span><span style="color:#A6ACCD;">scope</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">currentInstance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// const instance = currentInstance</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">getter</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">forceTrigger</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// æ˜¯å¦ç«‹å³æ‰§è¡Œæ ‡è¯† ä¸åŒäºimmediate</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isMultiSource</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// ç›‘å¬å¤šä¸ªæ•°æ®æ ‡è¯†</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// æ ¹æ® ç›‘å¬æ•°æ® åˆ¤æ–­å¹¶èµ‹å€¼ getter</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isRef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{...}</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// ref</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isReactive</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{...}</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// reactive</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isArray</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{...}</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// æ•°ç»„</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isFunction</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{...}</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å‡½æ•°ï¼ŒwatchEffect åœ¨é‡Œé¢çš„elseé‡Œé¢</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// ä¸åˆæ³• ç»™getterèµ‹å€¼ devä¸‹æŠ›è­¦å‘Š</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">NOOP</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// NOOP = ()=&gt;{}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">warnInvalidSource</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__COMPAT__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">deep</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{...}</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å…¼å®¹2.x</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deep</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// watch æ·±åº¦ç›‘å¬</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">baseGetter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">getter</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">traverse</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">baseGetter</span><span style="color:#F07178;">()) </span><span style="color:#676E95;font-style:italic;">// éå†å¯æšä¸¾çš„key å®ç°æ·±åº¦ç›‘å¬</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// æ¸…ç†å‰¯ä½œç”¨å‡½æ•°</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cleanup</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">void</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">onCleanup</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">OnCleanup</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">fn</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">void</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{...}</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// æœåŠ¡ç«¯ç›¸å…³</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ssrCleanup</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">void</span><span style="color:#F07178;">)[] </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">undefined</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__SSR__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isInSSRComponentSetup</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{...}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isMultiSource</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Array</span><span style="color:#F07178;">((</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> [])</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fill</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">INITIAL_WATCHER_VALUE</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">INITIAL_WATCHER_VALUE</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// å£°æ˜ä¸€ä¸ª job é‡Œé¢å°±æ˜¯å…·ä½“æ‰§è¡Œ effect.run çš„</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">job</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">SchedulerJob</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{...}</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// è¿è¡Œé€’å½’ æ ‡è¯†</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">job</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">allowRecurse</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!!</span><span style="color:#A6ACCD;">cb</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">scheduler</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">EffectScheduler</span></span>
<span class="line"><span style="color:#89DDFF;">   </span><span style="color:#676E95;font-style:italic;">// æ ¹æ®flush çš„å€¼å¯¹åº”è§¦å‘ job å‡½æ•°çš„è°ƒç”¨</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">flush</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">sync</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{...}</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// åŒæ­¥æ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">flush</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">post</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{...}</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å¼‚æ­¥é˜Ÿåˆ—ç»“æŸåæ‰§è¡Œ domæ›´æ–°å</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{...}</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// é»˜è®¤ å¼‚æ­¥é˜Ÿåˆ—å¼€å§‹å‰ dom æ›´æ–°å‰</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// effect ä¼ å…¥å‰¯ä½œç”¨å‡½æ•°ï¼Œå’Œè°ƒåº¦é…ç½®ï¼Œåœ¨ä¾èµ–æ›´æ–°æ‰§è¡Œå¯¹åº”å‰¯ä½œç”¨å‡½æ•°</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">ReactiveEffect</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">getter</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">scheduler</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// dev ä¸‹ onTrack/onTrigger æ”¶é›†ä¾èµ–/è§¦å‘æ›´æ–°æ—¶æ‰§è¡Œå›è°ƒ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">onTrack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">onTrack</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">onTrigger</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">onTrigger</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// initial run åˆ¤æ–­åˆå§‹åŒ–çš„å›è°ƒçš„æ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{...}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">flush</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">post</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{...}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">	</span><span style="color:#676E95;font-style:italic;">// ç»ˆæ­¢å‡½æ•°ï¼Œç”¨äºåœæ­¢ç›‘å¬</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">unwatch</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{...}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">unwatch</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>å…ˆæ˜¯å®šä¹‰äº†å‡ ä¸ªå˜é‡ï¼š</p><ul><li><strong>instance</strong> å½“å‰ç»„ä»¶å®ä¾‹</li><li><strong>getter</strong> å®ä¾‹åŒ–effect ä¼ å…¥çš„å‰¯ä½œç”¨å‡½æ•°</li><li><strong>forceTrigger</strong> å¼ºåˆ¶æ‰§è¡Œ</li><li><strong>isMultiSource</strong> ç›‘å¬æ•°æ®æºä¸ºå¤šä¸ª</li></ul><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> instance </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  Â  </span><span style="color:#82AAFF;">getCurrentScope</span><span style="color:#A6ACCD;">() </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> currentInstance</span><span style="color:#89DDFF;">?.</span><span style="color:#A6ACCD;">scope </span><span style="color:#89DDFF;">?</span><span style="color:#A6ACCD;"> currentInstance </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#676E95;font-style:italic;">// const instance = currentInstance</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> getter</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">any</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> forceTrigger </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> isMultiSource </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"></span></code></pre></div><h3 id="_1-æ ¹æ®sourceç±»å‹-åˆ†åˆ«å¤„ç†å¹¶èµ‹å€¼getter" tabindex="-1">1. æ ¹æ®sourceç±»å‹ï¼Œåˆ†åˆ«å¤„ç†å¹¶èµ‹å€¼getter <a class="header-anchor" href="#_1-æ ¹æ®sourceç±»å‹-åˆ†åˆ«å¤„ç†å¹¶èµ‹å€¼getter" aria-label="Permalink to &quot;1. æ ¹æ®sourceç±»å‹ï¼Œåˆ†åˆ«å¤„ç†å¹¶èµ‹å€¼getter&quot;">â€‹</a></h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/64e4959049924af18d3b9d6cd5468909~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p><p>å¯¹åº”ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (</span><span style="color:#82AAFF;">isRef</span><span style="color:#A6ACCD;">(source)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">forceTrigger</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">isShallow</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (</span><span style="color:#82AAFF;">isReactive</span><span style="color:#A6ACCD;">(source)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">source</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">deep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (</span><span style="color:#82AAFF;">isArray</span><span style="color:#A6ACCD;">(source)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">isMultiSource</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">forceTrigger</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">some</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;font-style:italic;">s</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">isReactive</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">isShallow</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;font-style:italic;">s</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isRef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isReactive</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">traverse</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isFunction</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">callWithErrorHandling</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_GETTER</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">warnInvalidSource</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (</span><span style="color:#82AAFF;">isFunction</span><span style="color:#A6ACCD;">(source)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#676E95;font-style:italic;">// getter with cb</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#82AAFF;">callWithErrorHandling</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_GETTER</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#676E95;font-style:italic;">// no cb -&gt; simple effect</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">isUnmounted</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cleanup</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#82AAFF;">cleanup</span><span style="color:#F07178;">() </span><span style="color:#676E95;font-style:italic;">// å­˜åœ¨ä¸Šä¸€æ¬¡çš„å‰¯ä½œç”¨å‡½æ•°å…ˆæ¸…ç†</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">callWithAsyncErrorHandling</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_CALLBACK</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  [</span><span style="color:#A6ACCD;">onCleanup</span><span style="color:#F07178;">] </span><span style="color:#676E95;font-style:italic;">// ä¼ å…¥onCleanupå‡½æ•°ï¼Œä»¥ä¾¿åœ¨å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæ¯•åæ¸…ç†å…¶å‰¯ä½œç”¨</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  )</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// å¦‚æœéƒ½ä¸æ»¡è¶³ï¼šgetter = () =&gt; {} deæŠ›å‡ºè­¦å‘Š</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">NOOP</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">warnInvalidSource</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>ä¸Šé¢ä»£ç ä¸»è¦æ˜¯æ ¹æ®<strong>source</strong>ç±»å‹ä¸åŒï¼Œåˆ†åˆ«è¿›è¡Œå¤„ç†å¹¶èµ‹å€¼ç»™<strong>getter</strong>å‡½æ•°èµ‹å€¼</p><h3 id="_2-é’ˆå¯¹2-x-æ•°ç»„çš„å…¼å®¹å¤„ç†" tabindex="-1">2.é’ˆå¯¹2.x æ•°ç»„çš„å…¼å®¹å¤„ç† <a class="header-anchor" href="#_2-é’ˆå¯¹2-x-æ•°ç»„çš„å…¼å®¹å¤„ç†" aria-label="Permalink to &quot;2.é’ˆå¯¹2.x æ•°ç»„çš„å…¼å®¹å¤„ç†&quot;">â€‹</a></h3><p>å¦‚æœä½¿ç”¨ Vue 2.x ä¸­çš„ <strong>watch</strong> ç›‘å¬äº†ä¸€ä¸ªæ•°ç»„ï¼Œè€Œåœ¨å›è°ƒå‡½æ•°ä¸­ä¿®æ”¹äº†æ•°ç»„ï¼Œé‚£ä¹ˆ Vue 2.x ä¼šè‡ªåŠ¨è§¦å‘æ›´æ–°ã€‚ä½†åœ¨ Vue 3.x ä¸­ï¼Œç”±äºå¼•å…¥äº†åŸºäº Proxy çš„å“åº”å¼ç³»ç»Ÿï¼Œä¼šä½¿å¾—æ•°ç»„å˜å¼‚å¤±æ•ˆï¼Œéœ€è¦ä½¿ç”¨ <strong>watch</strong> API ä¸­çš„ <strong>deep</strong> é€‰é¡¹æ¥ç›‘å¬æ•°ç»„å†…éƒ¨å…ƒç´ çš„å˜åŒ–ã€‚</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 2.x array mutation watch compat</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (__COMPAT__ </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> cb </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">deep) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">baseGetter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">getter</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">val</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">baseGetter</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">isArray</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">val</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">checkCompatEnabled</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">DeprecationTypes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_ARRAY</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;">) </span><span style="color:#676E95;font-style:italic;">// æ£€æŸ¥å…¼å®¹æ€§çš„</span></span>
<span class="line"><span style="color:#F07178;">    ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#82AAFF;">traverse</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">val</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">val</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>Vue 3.x ä¸­ä½¿ç”¨äº† <strong>watch</strong> API ç›‘å¬äº†ä¸€ä¸ªæ•°ç»„ï¼Œå¹¶ä¸”æ²¡æœ‰é»˜è®¤å¯ç”¨ <strong>deep</strong> é€‰é¡¹ï¼Œé‚£ä¹ˆæ•°ç»„å˜åŒ–ï¼Œwatch å®é™…ä¸Šæ˜¯ç›‘å¬ä¸åˆ°çš„ã€<strong>å®æµ‹</strong>ã€‘ï¼Œ æ‰€ä»¥æˆ‘ä»¬ç›‘å¬æ•°ç»„çš„æ—¶å€™è®°å¾— åŠ ä¸Š<strong>deep</strong></p><h3 id="_3-å­˜åœ¨deep-é€’å½’éå†å±æ€§" tabindex="-1">3.å­˜åœ¨deep é€’å½’éå†å±æ€§ <a class="header-anchor" href="#_3-å­˜åœ¨deep-é€’å½’éå†å±æ€§" aria-label="Permalink to &quot;3.å­˜åœ¨deep é€’å½’éå†å±æ€§&quot;">â€‹</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (cb </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> deep) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">baseGetter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">getter</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">traverse</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">baseGetter</span><span style="color:#F07178;">())</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>ç´§æ¥ç€ å£°æ˜äº†æ¸…ç†å‰¯ä½œç”¨å‡½æ•°ï¼Œåœ¨æ‰§è¡Œå®Œå›è°ƒæ—¶æ‰§è¡Œ</p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> cleanup</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">void</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> onCleanup</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">OnCleanup</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">fn</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">void</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">cleanup</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onStop</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">callWithErrorHandling</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">fn</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_CLEANUP</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h3 id="_4-jobå‡½æ•°" tabindex="-1">4. jobå‡½æ•° <a class="header-anchor" href="#_4-jobå‡½æ•°" aria-label="Permalink to &quot;4. jobå‡½æ•°&quot;">â€‹</a></h3><p><strong>job å‡½æ•°æ˜¯ effect çš„ä¸€ä¸ªè°ƒåº¦å™¨</strong></p><ol><li>å…ˆåˆ¤æ–­ effect æ˜¯å¦æ˜¯æ¿€æ´»çŠ¶æ€ï¼Œä¸æ˜¯ç›´æ¥return</li><li>å­˜åœ¨<strong>cb</strong> ï¼ˆ<strong>watch</strong>ï¼‰æ‰§è¡Œ effect.run() è®¡ç®—å‡ºæ–°å€¼ï¼Œåˆ¤æ–­æ–°ã€æ—§å€¼ï¼Œæ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼Œå¦‚æœæ”¹å˜äº†ï¼Œå­˜åœ¨ä¸Šä¸€æ¬¡å‰¯ä½œç”¨å‡½æ•°ï¼Œå…ˆæ¸…ç†å‰¯ä½œç”¨ï¼ŒæŠŠå›è°ƒã€å‚æ•°ã€æ¸…ç†å‰¯ä½œç”¨å‡½æ•°ç­‰ä¼ å…¥callWithAsyncErrorHandlingå»æ‰§è¡Œï¼Œç„¶åæ›´æ–°æ—§å€¼</li><li>ä¸å­˜åœ¨<strong>cb</strong> (<strong>watchEffect</strong>) ç›´æ¥è°ƒç”¨effect.run =ã€‹getter</li></ol><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> job</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">SchedulerJob</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">active</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// åˆ¤æ–­ effect æ˜¯å¦æ˜¯æ¿€æ´»çŠ¶æ€</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#676E95;font-style:italic;">// watch(source, cb) </span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">() </span><span style="color:#676E95;font-style:italic;">// è·å–æ–°å€¼</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#A6ACCD;">deep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#A6ACCD;">forceTrigger</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  (</span><span style="color:#A6ACCD;">isMultiSource</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">newValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#F07178;">[])</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">some</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">v</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;font-style:italic;">i</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  Â  Â  </span><span style="color:#82AAFF;">hasChanged</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">v</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">oldValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#F07178;">[])[</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">])</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  Â  )</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">hasChanged</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">newValue</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  (</span><span style="color:#A6ACCD;">__COMPAT__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#82AAFF;">isArray</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">newValue</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#82AAFF;">isCompatEnabled</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">DeprecationTypes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_ARRAY</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// åˆ¤æ–­ æ–°ã€æ—§å€¼ å¦‚æœå‘ç”Ÿäº†æ”¹å˜</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#676E95;font-style:italic;">// cleanup before running cb again</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cleanup</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#82AAFF;">cleanup</span><span style="color:#F07178;">() </span><span style="color:#676E95;font-style:italic;">// å…ˆæ¸…ç†ä¸Šä¸€æ¬¡çš„å‰¯ä½œç”¨</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// ä¼ å…¥ æ–°å€¼ æ¸…ç†å‰¯ä½œç”¨å‡½æ•° è°ƒç”¨å›è°ƒå‡½æ•°</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#82AAFF;">callWithAsyncErrorHandling</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">cb</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_CALLBACK</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> [</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">newValue</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#676E95;font-style:italic;">// pass undefined as the old value when it&#39;s changed for the first time</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">INITIAL_WATCHER_VALUE</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isMultiSource</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">INITIAL_WATCHER_VALUE</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> []</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">onCleanup</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  ])</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// æ—§å€¼èµ‹å€¼</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newValue</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#676E95;font-style:italic;">// watchEffect ç›´æ¥æ‰§è¡Œæ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>æ¥ç€æ ¹æ®<strong>flush</strong> çš„å€¼ å¤„ç† jobå‡½æ•°ï¼Œå°±æ˜¯å†³å®šå›è°ƒçš„æ‰§è¡Œæ—¶æœºï¼Œèµ‹å€¼ç»™è°ƒåº¦å™¨ scheduler</p><h3 id="_5-å®ä¾‹åŒ–-effect" tabindex="-1">5. å®ä¾‹åŒ– effect <a class="header-anchor" href="#_5-å®ä¾‹åŒ–-effect" aria-label="Permalink to &quot;5. å®ä¾‹åŒ– effect&quot;">â€‹</a></h3><p>ç„¶åä¼ å…¥ <strong>getter</strong> å’Œ <strong>schedluer</strong> å¹¶<a href="https://juejin.cn/post/7209510210422685755" target="_blank" rel="noreferrer">å®ä¾‹åŒ– effect</a></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#A6ACCD;"> scheduler</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">EffectScheduler</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (flush </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">sync</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// åŒæ­¥æ‰§è¡Œä¸åšå¤„ç†</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">scheduler</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">job</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// the scheduler function gets called directly</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (flush </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">post</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å¼‚æ­¥ åœ¨æ¸²æŸ“å®Œdom åæ‰§è¡Œ</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">scheduler</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">queuePostRenderEffect</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">job</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">suspense</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// é»˜è®¤pre åœ¨dom æ¸²æŸ“å‰æ‰§è¡Œ</span></span>
<span class="line"><span style="color:#89DDFF;">  </span><span style="color:#676E95;font-style:italic;">// default: &#39;pre&#39;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">job</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">pre</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;">) </span><span style="color:#A6ACCD;">job</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">uid</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">scheduler</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">queueJob</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">job</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// å®ä¾‹åŒ– effect </span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> effect </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ReactiveEffect</span><span style="color:#A6ACCD;">(getter</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> scheduler)</span></span>
<span class="line"></span></code></pre></div><h3 id="_6-åˆå§‹åŒ–å¹¶è¿”å›ç»ˆæ­¢ç›‘å¬å‡½æ•°" tabindex="-1">6.åˆå§‹åŒ–å¹¶è¿”å›ç»ˆæ­¢ç›‘å¬å‡½æ•° <a class="header-anchor" href="#_6-åˆå§‹åŒ–å¹¶è¿”å›ç»ˆæ­¢ç›‘å¬å‡½æ•°" aria-label="Permalink to &quot;6.åˆå§‹åŒ–å¹¶è¿”å›ç»ˆæ­¢ç›‘å¬å‡½æ•°&quot;">â€‹</a></h3><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// initial run</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (cb) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">immediate</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">job</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (flush </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">post</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// å¼‚æ­¥ æ¨å…¥é˜Ÿåˆ—ä¸­ï¼Œä¸‹ä¸€æ¬¡dom</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#82AAFF;">queuePostRenderEffect</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">run</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">suspense</span></span>
<span class="line"><span style="color:#F07178;">  )</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// ç»ˆæ­¢ç›‘å¬ </span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> unwatch </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stop</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">scope</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">remove</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">scope</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">effects</span><span style="color:#89DDFF;">!,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> unwatch</span></span>
<span class="line"></span></code></pre></div><p><em>æ­å–œä½ </em>ğŸ‘»ğŸ‘»ğŸ‘»ï¼ï¼ï¼çœ‹åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œä¸‹é¢æ˜¯å®Œæ•´çš„<strong>dowatch</strong> æºç </p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">doWatch</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#A6ACCD;font-style:italic;">source</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchSource</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchSource</span><span style="color:#A6ACCD;">[] </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchEffect</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">object</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#A6ACCD;font-style:italic;">cb</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchCallback</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">null</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">immediate</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">deep</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">flush</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">onTrack</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">onTrigger</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchOptions</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> EMPTY_OBJ</span></span>
<span class="line"><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">WatchStopHandle</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">immediate</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">warn</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">watch() &quot;immediate&quot; option is only respected when using the </span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">watch(source, callback, options?) signature.</span><span style="color:#89DDFF;">\`</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  )</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">deep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!==</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">warn</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">watch() &quot;deep&quot; option is only respected when using the </span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">watch(source, callback, options?) signature.</span><span style="color:#89DDFF;">\`</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  )</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">warnInvalidSource</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">s</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">unknown</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">warn</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">Invalid watch source: </span><span style="color:#89DDFF;">\`</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">A watch source can only be a getter/effect function, a ref, </span><span style="color:#89DDFF;">\`</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">\`</span><span style="color:#C3E88D;">a reactive object, or an array of these types.</span><span style="color:#89DDFF;">\`</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  )</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">getCurrentScope</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">currentInstance</span><span style="color:#89DDFF;">?.</span><span style="color:#A6ACCD;">scope</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">currentInstance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">null</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#676E95;font-style:italic;">// const instance = currentInstance</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">getter</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">forceTrigger</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isMultiSource</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">false</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isRef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">forceTrigger</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">isShallow</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isReactive</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">source</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">deep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isArray</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">isMultiSource</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">forceTrigger</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">some</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;font-style:italic;">s</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">isReactive</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">isShallow</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">map</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;font-style:italic;">s</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isRef</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">value</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isReactive</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">traverse</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isFunction</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">callWithErrorHandling</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_GETTER</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">warnInvalidSource</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">s</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isFunction</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#676E95;font-style:italic;">// getter with cb</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#82AAFF;">callWithErrorHandling</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_GETTER</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#676E95;font-style:italic;">// no cb -&gt; simple effect</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">isUnmounted</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cleanup</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#82AAFF;">cleanup</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">callWithAsyncErrorHandling</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">source</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_CALLBACK</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  [</span><span style="color:#A6ACCD;">onCleanup</span><span style="color:#F07178;">]</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  )</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">NOOP</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">warnInvalidSource</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#676E95;font-style:italic;">// 2.x array mutation watch compat</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__COMPAT__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">deep</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">baseGetter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">getter</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">val</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">baseGetter</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#82AAFF;">isArray</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">val</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#82AAFF;">checkCompatEnabled</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">DeprecationTypes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_ARRAY</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#82AAFF;">traverse</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">val</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">val</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">deep</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">baseGetter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">getter</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">traverse</span><span style="color:#F07178;">(</span><span style="color:#82AAFF;">baseGetter</span><span style="color:#F07178;">())</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">cleanup</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">void</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">onCleanup</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">OnCleanup</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">fn</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">void</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">cleanup</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">onStop</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">callWithErrorHandling</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">fn</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_CLEANUP</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#676E95;font-style:italic;">// in SSR there is no need to setup an actual effect, and it should be noop</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#676E95;font-style:italic;">// unless it&#39;s eager or sync flush</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ssrCleanup</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">void</span><span style="color:#F07178;">)[] </span><span style="color:#89DDFF;">|</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">undefined</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__SSR__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isInSSRComponentSetup</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#676E95;font-style:italic;">// we will also not call the invalidate callback (+ runner is not set up)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">onCleanup</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">NOOP</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">immediate</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">callWithAsyncErrorHandling</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">cb</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_CALLBACK</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> [</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#82AAFF;">getter</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#A6ACCD;">isMultiSource</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> [] </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#A6ACCD;">onCleanup</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  ])</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">flush</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">sync</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ctx</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">useSSRContext</span><span style="color:#F07178;">() </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">SSRContext</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">ssrCleanup</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ctx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__watcherHandles</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">ctx</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">__watcherHandles</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> [])</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">NOOP</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isMultiSource</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">Array</span><span style="color:#F07178;">((</span><span style="color:#A6ACCD;">source</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> [])</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">length</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fill</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">INITIAL_WATCHER_VALUE</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">INITIAL_WATCHER_VALUE</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">job</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">SchedulerJob</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">active</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">return</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#676E95;font-style:italic;">// watch(source, cb)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#A6ACCD;">deep</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#A6ACCD;">forceTrigger</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  (</span><span style="color:#A6ACCD;">isMultiSource</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">newValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#F07178;">[])</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">some</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">v</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;font-style:italic;">i</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  Â  Â  </span><span style="color:#82AAFF;">hasChanged</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">v</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">oldValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#F07178;">[])[</span><span style="color:#A6ACCD;">i</span><span style="color:#F07178;">])</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  Â  )</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">hasChanged</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">newValue</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">||</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  (</span><span style="color:#A6ACCD;">__COMPAT__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#82AAFF;">isArray</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">newValue</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">&amp;&amp;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#82AAFF;">isCompatEnabled</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">DeprecationTypes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_ARRAY</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  ) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#676E95;font-style:italic;">// cleanup before running cb again</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cleanup</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#82AAFF;">cleanup</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#82AAFF;">callWithAsyncErrorHandling</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">cb</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ErrorCodes</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WATCH_CALLBACK</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> [</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">newValue</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#676E95;font-style:italic;">// pass undefined as the old value when it&#39;s changed for the first time</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">INITIAL_WATCHER_VALUE</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">undefined</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">isMultiSource</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">] </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">INITIAL_WATCHER_VALUE</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">?</span><span style="color:#F07178;"> []</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  Â  </span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  Â  </span><span style="color:#A6ACCD;">onCleanup</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  ])</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  Â  </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">newValue</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#676E95;font-style:italic;">// watchEffect</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#676E95;font-style:italic;">// important: mark the job as a watcher callback so that scheduler knows</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#676E95;font-style:italic;">// it is allowed to self-trigger (#1727)</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#A6ACCD;">job</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">allowRecurse</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!!</span><span style="color:#A6ACCD;">cb</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">let</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">scheduler</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">EffectScheduler</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">flush</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">sync</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">scheduler</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">job</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">any</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// the scheduler function gets called directly</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">flush</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">post</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">scheduler</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">queuePostRenderEffect</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">job</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">suspense</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#676E95;font-style:italic;">// default: &#39;pre&#39;</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">job</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">pre</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;">) </span><span style="color:#A6ACCD;">job</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">id</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">uid</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">scheduler</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">queueJob</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">job</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">ReactiveEffect</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">getter</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">scheduler</span><span style="color:#F07178;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__DEV__</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">onTrack</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">onTrack</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">onTrigger</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">onTrigger</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#676E95;font-style:italic;">// initial run</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">cb</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">immediate</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">job</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">oldValue</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">flush</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">===</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">post</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#82AAFF;">queuePostRenderEffect</span><span style="color:#F07178;">(</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">run</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">bind</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">suspense</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  )</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">run</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">unwatch</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">()</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#A6ACCD;">effect</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">stop</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">scope</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  Â  </span><span style="color:#82AAFF;">remove</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">scope</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">effects</span><span style="color:#89DDFF;">!,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">effect</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">__SSR__</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">ssrCleanup</span><span style="color:#F07178;">) </span><span style="color:#A6ACCD;">ssrCleanup</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">push</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">unwatch</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">Â  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">unwatch</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="è¾…åŠ©å‡½æ•°" tabindex="-1">è¾…åŠ©å‡½æ•° <a class="header-anchor" href="#è¾…åŠ©å‡½æ•°" aria-label="Permalink to &quot;è¾…åŠ©å‡½æ•° {#è¾…åŠ©å‡½æ•°}&quot;">â€‹</a></h2><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isShallow</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">unknown</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!!</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Target</span><span style="color:#F07178;">)[</span><span style="color:#A6ACCD;">ReactiveFlags</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">IS_SHALLOW</span><span style="color:#F07178;">])</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> isFunction </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">val</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">unknown</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">val</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Function</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">Â  </span><span style="color:#89DDFF;">typeof</span><span style="color:#A6ACCD;"> val </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">function</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> isArray </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Array</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">isArray</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> isPlainObject </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">val</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">unknown</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">val</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">object</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#82AAFF;">toTypeString</span><span style="color:#A6ACCD;">(val) </span><span style="color:#89DDFF;">===</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">[object Object]</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">isReactive</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">value</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">unknown</span><span style="color:#89DDFF;">):</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#82AAFF;">isReadonly</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;">)) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">isReactive</span><span style="color:#F07178;">((</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Target</span><span style="color:#F07178;">)[</span><span style="color:#A6ACCD;">ReactiveFlags</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RAW</span><span style="color:#F07178;">])</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">!!</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#F07178;"> (</span><span style="color:#A6ACCD;">value</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">as</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Target</span><span style="color:#F07178;">)[</span><span style="color:#A6ACCD;">ReactiveFlags</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">IS_REACTIVE</span><span style="color:#F07178;">])</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><h2 id="æ€»ç»“" tabindex="-1">æ€»ç»“ <a class="header-anchor" href="#æ€»ç»“" aria-label="Permalink to &quot;æ€»ç»“ {#æ€»ç»“}&quot;">â€‹</a></h2><p>é¦–å…ˆé€šè¿‡<strong>source</strong>ç›‘å¬æ•°æ®æºçš„ç±»å‹åˆ›å»º<strong>getter</strong>ï¼Œæ¯”å¦‚æ•°æ®æºæ˜¯ä¸€ä¸ª<strong>reactive</strong> å¯¹è±¡ï¼Œå®ƒå°†è‡ªåŠ¨å¯ç”¨deepï¼Œå¯¹æ¯ä¸€ä¸ªå±æ€§åˆ›å»ºä¸€ä¸ªgetterï¼Œå¦‚æœæ˜¯åµŒå¥—å¯¹è±¡ï¼Œåˆ™é€šè¿‡<strong>traverse</strong> å‡½æ•°è¿›è¡Œé€’å½’éå†ã€‚<strong>job</strong>æ˜¯ç”¨æ¥å¤„ç†watchå’ŒwatchEffect ä¸­å‰¯ä½œç”¨çš„å…·ä½“æ‰§è¡Œçš„å‡½æ•°ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç”¨æ¥è®¡ç®—æ–°æ—§å€¼çš„ã€‚<br> æ¥ç€é€šè¿‡<em>flush</em>å£°æ˜ç”¨æ¥æ§åˆ¶watch å›è°ƒçš„æ‰§è¡Œæ—¶æœºçš„<strong>schedluerå¯¹è±¡</strong></p><ul><li>flush=sync =&gt; <strong>schedluer</strong>=job // åŒæ­¥</li><li>flush=post =&gt; <strong>schedluer = () =&gt;</strong> queuePostRenderEffect(job,xxx) // dom æ›´æ–°å</li><li>flush=pre =&gt; <strong>schedluer</strong> =&gt; queueJob(job) // dom æ›´æ–°å‰</li></ul><p>æ¥ç€å®ä¾‹åŒ–<em>effect</em>=new ReactiveEffect(getter, scheduler)<br> ç„¶ååˆå§‹åŒ–æ‰§è¡Œï¼šwatchEffectã€watch å­˜åœ¨ immediate åˆ™ç¬¬ä¸€æ¬¡é»˜è®¤æ‰§è¡Œ<br> æœ€åå£°æ˜å¹¶è¿”å›ä¸€ä¸ªç»ˆæ­¢å‡½æ•° <strong>unwatch</strong></p><h2 id="æ³¨æ„äº‹é¡¹ï¼š" tabindex="-1">æ³¨æ„äº‹é¡¹ï¼š <a class="header-anchor" href="#æ³¨æ„äº‹é¡¹ï¼š" aria-label="Permalink to &quot;æ³¨æ„äº‹é¡¹ï¼š {#æ³¨æ„äº‹é¡¹ï¼š}&quot;">â€‹</a></h2><ul><li>ç›‘å¬ä¸€ä¸ªåµŒå¥—å“åº”å¯¹è±¡æ—¶ï¼Œé»˜è®¤å¯ç”¨deep</li><li>ç›‘å¬æ•°ç»„ å¿…é¡»å£°æ˜deep æ‰èƒ½ç›‘å¬åˆ°</li><li>watchEffec é»˜è®¤ç¬¬ä¸€æ¬¡ä¼šæ‰§è¡Œï¼Œæ²¡æœ‰æ–°ã€æ—§å€¼æ¦‚å¿µ</li><li>watchEffect å›è°ƒçš„å‚æ•°å¯ä»¥ç”¨æ¥æ¸…ç†ä¸Šä¸€æ¬¡å‰¯ä½œç”¨</li><li>å¯ä»¥é€šè¿‡flushæ¥æ§åˆ¶watchå’ŒwatchEffecå›è°ƒçš„æ‰§è¡Œæ—¶æœº</li><li>deep å®ç°æ·±åº¦ç›‘å¬åŸç†æ˜¯traverse é€’å½’æ¯ä¸€ä¸ªå±æ€§ï¼Œ[æ…ç”¨äºç›‘å¬åµŒå¥—è¿‡æ·±æ•°æ®ï¼Œæ€§èƒ½é—®é¢˜]</li><li>watch ç›‘å¬çš„æ•°æ®æºæ˜¯å¤šä¸ªæ—¶ï¼Œå›è°ƒå‡½æ•°å‚æ•°ä¹Ÿæ˜¯æ•°ç»„ï¼ˆ[new1,new2],[old1,old2]ï¼‰</li><li>watchå›è°ƒä¸­ä¸è¦ç›´æ¥ä¿®æ”¹ç›‘å¬çš„æ•°æ®æºï¼Œå®åœ¨è¦ä¿®æ”¹ï¼Œå¯ä»¥åˆ¤æ–­ä¸€ä¸‹æ–°ã€æ—§å€¼å†æ”¹</li></ul>`,82),e=[o];function t(c,r,y,F,D,A){return n(),a("div",null,e)}const f=s(p,[["render",t]]);export{i as __pageData,f as default};
